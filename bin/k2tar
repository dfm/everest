#!/usr/bin/env python
# -*- coding: utf-8 -*-
'''
k2tar
-----

Creates tarballs of the .fits and .pdf files for uploading to MAST.

'''

from everest.config import EVEREST_DAT
import os, shutil
import subprocess
import argparse

if __name__ == '__main__':
  parser = argparse.ArgumentParser()
  parser.add_argument("campaign", type = int, help = 'The campaign to tar')
  parser.add_argument("-c", "--cadence", type = str, default = 'lc', help = 'Cadence type (lc | sc)')
  args = parser.parse_args()
  cadence = args.cadence
  campaign = args.campaign
  
  # Get all subcampaigns
  subcampaigns = [int(s) for s in os.listdir(os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign)) if s.endswith('00000')]
  
  # Loop over them
  for subcampaign in subcampaigns:
    
    # Select cadence
    if cadence == 'lc':
      cmd = 'find ./%d -name "nPLD.pdf" -o -name "*_lc.fits" | tar -czvf %d.tar.gz -T -' % (subcampaign, subcampaign)
    else:
      cmd = 'find ./%d -name "nPLD.sc.pdf" -o -name "*_sc.fits" | tar -czvf %d.tar.gz -T -' % (subcampaign, subcampaign)
    
    # Tar it up
    if not os.path.exists(os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign, '%d.tar.gz' % subcampaign)):
      subprocess.call(cmd, shell = True, cwd = os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign))
    
      # Delete the fits files
      if cadence == 'lc':
        subprocess.call('rm %s' % os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign, 
                        '%d' % subcampaign, '*', '*', '*_lc.fits'), shell = True)
      else:
        subprocess.call('rm %s' % os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign, 
                        '%d' % subcampaign, '*', '*', '*_sc.fits'), shell = True)