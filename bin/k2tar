#!/usr/bin/env python
# -*- coding: utf-8 -*-
'''
k2tar
-----

Creates tarballs of the .fits and .pdf files for uploading to MAST.

'''

from everest.config import EVEREST_DAT
import os, shutil
import subprocess
import argparse

if __name__ == '__main__':
  parser = argparse.ArgumentParser()
  parser.add_argument("campaign", type = int, help = 'The campaign to tar')
  parser.add_argument("-c", "--cadence", type = str, default = 'lc', help = 'Cadence type (lc | sc)')
  args = parser.parse_args()
  cadence = args.cadence
  cadext = ".sc" if cadence == 'sc' else ""
  campaign = args.campaign
  
  # Get all subcampaigns
  subcampaigns = [int(s) for s in os.listdir(os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign)) if s.endswith('00000')]
  
  # Loop over them
  for subcampaign in subcampaigns:

    # Tar up the pdfs + fits files
    cmd = 'find ./%d -name "nPLD%s.pdf" -o -name "*_%s.fits" | tar -czvf %d%s.tar.gz -T -' % (subcampaign, cadext, cadence, subcampaign, cadext)
    if not os.path.exists(os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign, '%d%s.tar.gz' % (subcampaign, cadext))):
      subprocess.call(cmd, shell = True, cwd = os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign))
    
      # Delete the fits files
      subprocess.call('rm %s' % os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign, 
                      '%d' % subcampaign, '*', '*_%s.fits' % cadence), shell = True)
    
    # Tar up the pdfs + npz + log files
    cmd = 'find ./%d -name "nPLD%s.pdf" -o -name "nPLD%s.npz" -o -name "nPLD%s.log" | tar -czvf /lolo/archive/hyak/vsm/rodluger/everest2/k2/c%02d/%d%s.tar.gz -T -' % (subcampaign, cadext, cadext, cadext, campaign, subcampaign, cadext)
    if not os.path.exists(os.path.join('/lolo/archive/hyak/vsm/rodluger/everest2/k2', 'c%02d' % campaign, '%d%s.tar.gz' % (subcampaign, cadext))):
      subprocess.call(cmd, shell = True, cwd = os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign))
    
      # Delete them
      #subprocess.call('rm %s' % os.path.join(EVEREST_DAT, 'k2', 'c%02d' % campaign, 
      #                '%d' % subcampaign, '*', 'nPLD%s.*' % cadext), shell = True)